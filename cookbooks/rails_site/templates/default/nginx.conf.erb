# <%= @server_type %> + Nginx Config for <%= @name %> Generated by Chef
#
# Use SSL: <%= @use_ssl ? "Yes" : "No" %>
# Capified Deploy: <%= @capified ? "Yes" : "No" %>
# App Path: <%= @app_path %>

# define <%= @server_type %> backend
upstream <%= @name %>_backend {
  server unix:<%= @app_path %>/<%= @capified ? "shared/sockets/#{@server_type}.sock" : "tmp/sockets/#{@server_type}.sock" %> fail_timeout=0;
}

# http server settings
server {
  listen <%= @is_default ? "#{@http_port} default_server" : @http_port %>;
  server_name <%= @server_name %>;
  root <%= @app_path %>/<%= @capified ? "current/public" : "public" %>; # for asset pipeline and other static files

  client_max_body_size 2G;
  keepalive_timeout    5;

  access_log /var/log/nginx/<%= @name %>.access.log combined;
  error_log  /var/log/nginx/<%= @name %>.error.log;

  location / {
    try_files $uri/index.html $uri.html $uri @<%= @name %>;
    client_max_body_size       2G;
    client_body_buffer_size    128k;

    recursive_error_pages on;

    if (-f $document_root/system/maintenance.html) {
      return 503;
    }

    error_page 404              /404.html;
    error_page 422              /422.html;
    error_page 500 502 504      /500.html;
    error_page 403              /403.html;
    error_page 503              @503;
  }

  location @503 {
    error_page 405 = /system/maintenance.html;

    # Serve static assets if found.
    if (-f $request_filename) {
      break;
    }
    rewrite ^(.*)$ /system/maintenance.html break;
  }

  location @<%= @name %> {
    proxy_pass http://<%= @name %>_backend;
    proxy_redirect                    off;
    proxy_set_header  Host            $host;
    proxy_set_header  X-Real-IP       $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;

    proxy_connect_timeout      120;
    proxy_send_timeout         120;
    proxy_read_timeout         120;

    proxy_buffer_size          4k;
    proxy_buffers              4 32k;
    proxy_busy_buffers_size    64k;
    proxy_temp_file_write_size 64k;
  }

  # location ~ \.(jpg|png|mp3|ogg)$ {
  #   valid_referers server_names;
  #   if ($invalid_referer) {
  #     return 403;
  #   }
  # }

  location ~ ^/(assets|stylesheets|images|javascripts).*\.(jpg|png|mp3|ogg|js|html|css|gif)$ {
    gzip_static on;
    expires     max;
    add_header  Cache-Control public;
  }

  if ($request_method !~ ^(GET|HEAD|PUT|POST|DELETE|OPTIONS)$ ) {
    return 405;
  }

  location ~ ^/(images|javascripts|stylesheets|assets)/ {
    expires max;
    break;
  }
}

<% if @use_ssl %>
# https server settings
server {
  listen <%= @is_default ? "#{@https_port} default_server" : @https_port %>;
  server_name <%= @server_name %>;
  root <%= @app_path %>/<%= @capified ? "current/public" : "public" %>; # for asset pipeline and other static files

  client_max_body_size 2G;
  keepalive_timeout    5;

  access_log /var/log/nginx/<%= @name %>.ssl.access.log combined;
  error_log  /var/log/nginx/<%= @name %>.ssl.error.log;

  ssl                  on;
  ssl_certificate      <%= @ssl_settings['certificate'] %>;
  ssl_certificate_key  <%= @ssl_settings['certificate_key'] %>;

  ssl_session_timeout  5m;

  ssl_protocols               SSLv2 SSLv3 TLSv1;
  ssl_ciphers                 HIGH:!aNULL:!MD5;
  ssl_prefer_server_ciphers   on;

  location / {
    try_files $uri/index.html $uri.html $uri @<%= @name %>;
    client_max_body_size       2G;
    client_body_buffer_size    128k;

    recursive_error_pages on;

    if (-f $document_root/system/maintenance.html) {
      return 503;
    }

    error_page 404              /404.html;
    error_page 422              /422.html;
    error_page 500 502 504      /500.html;
    error_page 403              /403.html;
    error_page 503              @503;
  }

  location @503 {
    error_page 405 = /system/maintenance.html;

    # Serve static assets if found.
    if (-f $request_filename) {
      break;
    }
    rewrite ^(.*)$ /system/maintenance.html break;
  }

  location @<%= @name %> {
    proxy_pass http://<%= @name %>_backend;
    proxy_redirect                    off;
    proxy_set_header  Host            $host;
    proxy_set_header  X-Real-IP       $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header  X-Forwarded-Proto https;

    proxy_connect_timeout      120;
    proxy_send_timeout         120;
    proxy_read_timeout         120;

    proxy_buffer_size          4k;
    proxy_buffers              4 32k;
    proxy_busy_buffers_size    64k;
    proxy_temp_file_write_size 64k;
  }

  # location ~ \.(jpg|png|mp3|ogg)$ {
  #   valid_referers server_names;
  #   if ($invalid_referer) {
  #     return 403;
  #   }
  # }

  location ~ ^/(assets|stylesheets|images|javascripts).*\.(jpg|png|mp3|ogg|js|html|css|gif)$ {
    gzip_static on;
    expires     max;
    add_header  Cache-Control public;
  }

  if ($request_method !~ ^(GET|HEAD|PUT|POST|DELETE|OPTIONS)$ ) {
    return 405;
  }

  location ~ ^/(images|javascripts|stylesheets|assets)/ {
    expires max;
    break;
  }
}
<% end %>